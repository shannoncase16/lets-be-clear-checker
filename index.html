<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Let's Be Clear</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; max-width: 600px; }
    button { margin-top: 10px; padding: 8px 14px; font-size: 16px; }
    video { width: 100%; max-width: 400px; border: 1px solid #ccc; margin-top: 20px; }
    #results { margin-top: 20px; padding: 12px; border: 1px solid #ccc; max-width: 600px; }
    .low { color: green; }
    .medium { color: orange; }
    .high { color: red; }
  </style>
</head>
<body>

<h1>Let's Be Clear</h1>

<h2>Option 1: Paste Ingredients</h2>
<textarea id="ingredientInput" rows="6" placeholder="Paste ingredient list here..."></textarea><br>
<button id="analyzeText">Analyze Ingredients</button>

<h2>Option 2: Scan Barcode</h2>
<p>Allow camera access and hold steady over barcode</p>
<video id="camera" autoplay playsinline></video>
<br>
<button onclick="location.reload()">Scan Another Product</button>

<div id="results">No analysis yet.</div>

<!-- Supabase -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://hmfjdsbfkgehybmeosxw.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtZmpkc2Jma2dlaHlibWVvc3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMjMyNzksImV4cCI6MjA4Mzc5OTI3OX0.fQyMIrURuqWYbvAJOYCQKbEu1fyUYZHiJtHmYGP_hO0"
  );

  window.supabase = supabase;
</script>

<!-- ZXing -->
<script type="module">
  import { BrowserBarcodeReader } from "https://cdn.jsdelivr.net/npm/@zxing/library/+esm";
  window.codeReader = new BrowserBarcodeReader();
</script>

<!-- App Logic -->
<script type="module">
  const resultsDiv = document.getElementById("results");
  const video = document.getElementById("camera");

  function normalize(str) {
    return str?.toLowerCase().replace(/[^a-z0-9]/g, "").trim();
  }

  function stopCamera(video) {
    const stream = video.srcObject;
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
  }

  async function analyzeIngredientList(ingredientArray) {
    const { data: ingredients, error } = await window.supabase
      .from("ingredients")
      .select("*");

    if (error) {
      resultsDiv.innerHTML = "Error loading ingredients.";
      return;
    }

    let totalScore = 0;
    let flaggedCount = 0;
    let listHTML = "";

    ingredientArray.forEach(name => {
      const match = ingredients.find(i =>
        normalize(i.inci_name) === normalize(name)
      );

      if (match) {
        totalScore += match.base_score;
        if (match.auto_flag) flaggedCount++;

        listHTML += `<li>${match.inci_name} â€“ ${match.explanation_short || ""}</li>`;
      }
    });

    let risk = "Low", cls = "low";
    if (totalScore > 12) { risk = "High"; cls = "high"; }
    else if (totalScore > 5) { risk = "Medium"; cls = "medium"; }

    resultsDiv.innerHTML = `
      <p><strong>Total comedogenic score:</strong> ${totalScore}
      <span class="${cls}">(${risk})</span></p>
      <p><strong>Flagged ingredients:</strong> ${flaggedCount}</p>
      <ul>${listHTML}</ul>
    `;
  }

  document.getElementById("analyzeText").addEventListener("click", () => {
    const raw = document.getElementById("ingredientInput").value;
    if (!raw) return;
    const list = raw.split(",").map(i => i.trim());
    analyzeIngredientList(list);
  });

  let scanning = false;

  window.codeReader.decodeFromVideoDevice(null, video, async (result) => {
    if (!result || scanning) return;

    scanning = true;
    const barcode = result.text;

    resultsDiv.innerHTML = `Barcode detected: ${barcode}`;

    stopCamera(video);

    const { data: products } = await window.supabase
      .from("products")
      .select("*")
      .eq("barcode", barcode)
      .limit(1);

    if (!products || products.length === 0) {
      resultsDiv.innerHTML = "Product not found.";
      return;
    }

    const product = products[0];
    const ingredients = product.inci_raw.split(",").map(i => i.trim());
    analyzeIngredientList(ingredients);
  });
</script>

</body>
</html>
